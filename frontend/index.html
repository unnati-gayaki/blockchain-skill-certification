    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>CertChain Pro | AI & QR Ledger Explorer</title>
        
        <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://unpkg.com/lucide@latest"></script>
        <!-- Added QR Code Library -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

        <style>
            :root {
                --slate-900: #0f172a;
                --slate-800: #1e293b;
                --indigo-600: #4f46e5;
                --emerald-500: #10b981;
                --border: #e2e8f0;
                --sidebar-width: 280px;
            }

            body {
                margin: 0; font-family: 'Plus Jakarta Sans', sans-serif;
                background: #f8fafc; color: var(--slate-900); display: flex; min-height: 100vh;
            }

            /* SIDEBAR */
            nav {
                width: var(--sidebar-width); background: var(--slate-900); color: white;
                padding: 2.5rem 1.5rem; display: flex; flex-direction: column; gap: 1rem;
                position: fixed; height: 100vh; z-index: 100;
            }
            .logo { font-size: 1.6rem; font-weight: 800; display: flex; align-items: center; gap: 12px; margin-bottom: 2rem; }
            .logo i { color: var(--emerald-500); }
            .nav-link {
                display: flex; align-items: center; gap: 12px; padding: 12px 16px;
                border-radius: 12px; cursor: pointer; transition: 0.3s; color: #94a3b8; font-weight: 500;
            }
            .nav-link:hover { background: var(--slate-800); color: white; }
            .nav-link.active { background: var(--indigo-600); color: white; }

            /* MAIN CONTENT */
            main { margin-left:var(--sidebar-width); flex: 1; padding: 2.5rem; }
            .view-container { display: none; }
            .view-container.active { display: block; }

            /* CARDS & UI */
            .card { background: white; border-radius: 24px; padding: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.03); border: 1px solid var(--border); margin-bottom: 2rem; }
            .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
            .input-group { margin-bottom: 1rem; }
            label { display: block; font-size: 0.85rem; font-weight: 700; margin-bottom: 0.5rem; }
            input, select { width: 100%; padding: 0.85rem; border-radius: 12px; border: 1.5px solid var(--border); font-family: inherit; }
            
            button {
                background: var(--slate-900); color: white; border: none; padding: 1rem;
                border-radius: 14px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%;
            }

            /* TABLE STYLING for LEDGER */
            .ledger-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
            .ledger-table th { text-align: left; padding: 12px; border-bottom: 2px solid var(--border); color: #64748b; font-size: 0.8rem; text-transform: uppercase; }
            .ledger-table td { padding: 15px 12px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; }
            .status-pill { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
            .pill-success { background: #dcfce7; color: #16a34a; }
            .hash-font { font-family: monospace; color: var(--indigo-600); font-size: 0.8rem; }

            /* AI PANEL & QR BOX */
            #aiPanel { display: none; background: #f1f5f9; border-radius: 20px; padding: 2rem; margin-top: 2rem; }
            .trust-meter { font-size: 2.5rem; font-weight: 800; color: var(--emerald-500); }
            .qr-container { 
                background: white; padding: 10px; border-radius: 12px; border: 1px solid var(--border);
                display: inline-block;
            }

            /* SEARCH BOX */
            .search-wrapper { position: relative; max-width: 500px; margin-bottom: 2rem; }
            .search-wrapper input { padding-left: 45px; border-radius: 15px; }
            .search-wrapper i { position: absolute; left: 15px; top: 13px; color: #64748b; }

        </style>
    </head>
    <body>

    <nav>
        <div class="logo"><i data-lucide="shield-check"></i> CertChain</div>
        <div class="nav-link active" onclick="switchView('issuance')"><i data-lucide="plus-circle"></i> Issuance Portal</div>
        <div class="nav-link" onclick="switchView('verification')"><i data-lucide="search"></i> Verification Center</div>
        <div class="nav-link" onclick="switchView('ledger')"><i data-lucide="database"></i> Ledger Explorer</div>
    </nav>

    <main>
        
        <!-- VIEW 1: ISSUANCE -->
        <div id="issuanceView" class="view-container active animate__animated animate__fadeIn">
            <div style="padding-left: 8px;">
                <h1>Issuance Console</h1>
            </div>

            <div class="grid" style="grid-template-columns: 2fr 1fr;">
                <div class="card">
                    <div class="grid">
                        <div class="input-group"><label>UID</label><input id="certId" placeholder="CERTID"></div>
                        <div class="input-group"><label>Student Name</label><input id="studentName" placeholder="John Doe"></div>
                    </div>
                    <div class="grid">
                        <div class="input-group">
                            <label>Claimed Skill</label>
                            <select id="claimed"><option>Advanced</option><option>Intermediate</option><option>Beginner</option></select>
                        </div>
                        <div class="input-group"><label>Course Track</label><input id="course" placeholder="Blockchain-AI"></div>
                    </div>
                    <div class="grid" style="grid-template-columns: repeat(4, 1fr);">
                        <input type="number" id="s1" placeholder="Theory"> <input type="number" id="s2" placeholder="Lab">
                        <input type="number" id="s3" placeholder="Project"> <input type="number" id="s4" placeholder="Logic ">
                    </div>  
                    <button id="btnIssue" onclick="runIssuance()"><i data-lucide="cpu"></i> Analyze & Commit to Blockchain</button>

                    <div id="aiPanel">
                        <div class="grid" style="grid-template-columns: 1.2fr 1fr 0.8fr; align-items: center;">
                            <div>
                                <label>AI Confidence Score</label>
                                <div class="trust-meter" id="trustScore">95.0%</div>
                                <p id="verdict" style="color:var(--emerald-500); font-weight: bold;">Skill Match Confirmed</p>
                            </div>
                            <div style="max-width: 150px;"><canvas id="radarChart"></canvas></div>
                            <div style="text-align: right;">
                                <label>Certificate QR</label>
                                <div id="issueQR" class="qr-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card" style="background: #0f172a; color: white;">
                    <label>Live activity</label>
                    <div id="sideLogs" style="font-size: 0.7rem; font-family: monospace; margin-top: 10px;"></div>
                </div>
            </div>
        </div>

        <!-- VIEW 2: VERIFICATION -->
        <div id="verificationView" class="view-container animate__animated animate__fadeIn">
            <h1>Verification Center</h1>
            <div class="card">
                <input id="searchId" placeholder="Enter UID to verify..." style="margin-bottom: 10px;">
                <button id="btnVerify" onclick="runVerification()" style="background: var(--indigo-600);">Verify Credential</button>
            </div>
            <div id="vResult" class="card" style="display:none; border-top: 5px solid var(--emerald-500);">
                <div class="grid" style="grid-template-columns: 2fr 1fr; align-items: center;">
                    <div>
                        <h2 id="vName" style="margin: 0 0 5px 0;"></h2>
                        <p id="vCourse" style="margin: 0 0 15px 0; color: #64748b; font-size: 1.1rem;"></p>
                        <div id="vBadge" class="status-pill pill-success" style="display: inline-block;">AUTHENTIC RECORD</div>
                    </div>
                    <div style="text-align: right;">
                        <div id="verifyQR" class="qr-container"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 3: LEDGER EXPLORER -->
        <div id="ledgerView" class="view-container animate__animated animate__fadeIn">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="padding-left: 8px;"></div>
                <h1>Ledger Explorer</h1>
                <div id="blockCount" style="font-size: 0.8rem; font-weight: 700; background: #e2e8f0; padding: 5px 15px; border-radius: 50px;">Blocks: 0</div>
            </div>
            
            <div class="search-wrapper">
                <i data-lucide="search"></i>
                <input type="text" id="ledgerSearch" placeholder="Search by student, UID or hash..." onkeyup="filterLedger()">
            </div>

            <div class="card" style="padding: 1rem;">
                <table class="ledger-table">
                    <thead>
                        <tr>
                            <th>Block</th>
                            <th>Timestamp</th>
                            <th>Student / UID</th>
                            <th>AI Result</th>
                            <th>TX Hash</th>
                        </tr>
                    </thead>
                    <tbody id="ledgerTableBody">
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <script>
    // Safe initialization
    try {
        lucide.createIcons();
    } catch (e) {
        console.warn("Icons failed to load. Check internet connection.");
    }

    // Use IP so phone scanning works (Ensure backend runs on 0.0.0.0)
    const API_BASE = "https://certchain-backend.onrender.com/api`";

    // ⚠️ IMPORTANT: For Phone Scanning to work, replace 'window.location.origin' 
    // with your computer's Local IP (e.g., "http://192.168.1.15:5500")
    // If you leave it as localhost, the phone will try to open localhost on itself.
    const CLIENT_URL =  "https://certchain-frontend.onrender.com"; 
    let radarChart;

    // Check for verification request in URL (e.g. from QR scan)
    window.onload = function() {
        const params = new URLSearchParams(window.location.search);
        const verifyId = params.get("verify");
        if (verifyId) {
            switchView("verification");
            document.getElementById("searchId").value = verifyId;
            runVerification();
        }
    };

    /* ---------------- NAV ---------------- */
    function switchView(view) {
        document.querySelectorAll('.view-container').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.getElementById(view + 'View').classList.add('active');
        event.currentTarget.classList.add('active');

        if (view === "ledger") loadLedger();
    }

    /* ---------------- ISSUE ---------------- */
    async function runIssuance() {
        console.log("Analyze button clicked...");
        
        const payload = {
            certId: document.getElementById("certId").value,
            studentName: document.getElementById("studentName").value,
            courseName: document.getElementById("course").value,
            test_score: Number(document.getElementById("s1").value),
            project_score: Number(document.getElementById("s3").value),
            claimedSkill: document.getElementById("claimed").value
        };
        // ✅ AI Confidence Calculation (ADD HERE)
        const avgScore =
            (payload.test_score + payload.project_score) / 2;

        const aiConfidence = Math.min(
            100,
            Math.round(avgScore)
        );


        if (!payload.certId || !payload.studentName) {
            alert("Fill all required fields");
            return;
        }

        // 1. START LOADING
        const btn = document.getElementById("btnIssue");
        const originalText = btn.innerHTML;
        btn.innerHTML = "⏳ Processing AI & Blockchain...";
        btn.disabled = true;

        try {
            const res = await fetch(`${API_BASE}/issue`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                const errData = await res.json().catch(() => ({}));
                throw new Error(errData.message || `Server Error: ${res.status}`);
            }

            const data = await res.json();

    // Show AI result
    document.getElementById("aiPanel").style.display = "block";
    document.getElementById("trustScore").innerText =
    aiConfidence + "%";
    document.getElementById("verdict").innerText =
        data.aiMatch ? "Skill Match Confirmed" : "Skill Mismatch";

    // Generate QR
    // Point to the Verification Page (this app) with ID param
    // This ensures scanning shows "REAL or FAKE" status immediately
    
    // Pointing to verify.html specifically as requested
    const currentPath = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
    const verifyUrl = "https://certchain-frontend.onrender.com/verify.html?certId=" + payload.certId;
    
    const qrContainer = document.getElementById("issueQR");
    qrContainer.innerHTML = "";
    if (typeof QRCode !== 'undefined') {
        new QRCode(qrContainer, {
            text: verifyUrl,
            width: 120,
            height: 120
        });
    } else {
        qrContainer.innerHTML = "⚠️ QR Lib missing";
    }

    // Ledger log & chart
    logSide(`✔ Block committed: ${data.txHash.slice(0,12)}...`);
    drawRadar([payload.test_score, 90, payload.project_score, 88]);

    // Generate & Download PDF Certificate
    // Wait briefly for QR to render on DOM
    setTimeout(() => generateCertificatePDF(payload), 500);

        } catch (err) {
            console.error(err);
            if (err.message === "Failed to fetch") {
                alert("Connection Failed: Ensure Backend is running on port 5000");
            } else {
                alert(err.message || "Certificate issue failed. Check input data.");
            }
        } finally {
            // 2. STOP LOADING
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    /* ---------------- VERIFY ---------------- */
    async function runVerification() {
        const id = document.getElementById("searchId").value;
        if (!id) return alert("Please enter a UID to verify");

        const btn = document.getElementById("btnVerify");
        const originalText = btn.innerHTML;
        btn.innerHTML = "Searching Ledger...";
        btn.disabled = true;

        try {
            const res = await fetch(`${API_BASE}/verify/${id}`);
            if (!res.ok) throw new Error();

            const data = await res.json();      

            // Show result card
            const vCard = document.getElementById("vResult");
            vCard.style.display = "block";
            vCard.style.borderTop = "5px solid var(--emerald-500)"; // Reset to Green

            document.getElementById("vName").innerText = data.studentName;
            document.getElementById("vCourse").innerText = data.courseName;

            const badge = document.getElementById("vBadge");
            badge.innerText = "AUTHENTIC RECORD";
            badge.className = "status-pill pill-success";
            badge.style.background = "#dcfce7";
            badge.style.color = "#16a34a";

            // ✅ CLEAR OLD QR (VERY IMPORTANT)
            const qrBox = document.getElementById("verifyQR");
            qrBox.innerHTML = "";

            // ✅ GENERATE QR CODE
            if (typeof QRCode !== 'undefined') {
                new QRCode(qrBox, {
                    text: `${window.location.origin}${window.location.pathname}?verify=${id}`,
                    width: 120,
                    height: 120
                });
            }

        } catch (err) {
            // Show FAKE result in UI instead of alert
            const vCard = document.getElementById("vResult");
            vCard.style.display = "block";
            vCard.style.borderTop = "5px solid #ef4444"; // Red for fake

            document.getElementById("vName").innerText = "Not Found";
            document.getElementById("vCourse").innerText = "ID: " + id;

            const badge = document.getElementById("vBadge");
            badge.innerText = "FAKE / NOT FOUND";
            badge.style.background = "#fee2e2";
            badge.style.color = "#b91c1c";

            document.getElementById("verifyQR").innerHTML = "";
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }


    /* ---------------- LEDGER ---------------- */
    async function loadLedger() {
        try {
            const res = await fetch(`${API_BASE}/ledger`);
            if (!res.ok) throw new Error();

            const data = await res.json();
            renderLedger(data);

        } catch {
            alert("Unable to load blockchain ledger");
        }
    }

    function renderLedger(blocks) {
        const body = document.getElementById("ledgerTableBody");
        body.innerHTML = "";

        blocks.reverse().forEach((b, i) => {
            body.innerHTML += `
            <tr>
                <td>#${i + 1}</td>
                <td>${new Date(b.issuedAt * 1000).toLocaleString()}</td>
                <td>
                    <b>${b.studentName}</b><br>
                    <small>${b.certId}</small>
                </td>
                <td><span class="status-pill pill-success">${b.aiMatch ? "Verified" : "Mismatch"}</span></td>
                <td class="hash-font">${b.issuer}</td>
            </tr>`;
        });
    }

    /* ---------------- UTIL ---------------- */
    function logSide(text) {
        const el = document.createElement("div");
        el.innerText = text;    
        document.getElementById("sideLogs").prepend(el);
    }

    function drawRadar(data) {
        if (radarChart) radarChart.destroy();
        const ctx = document.getElementById("radarChart").getContext("2d");
        radarChart = new Chart(ctx, {
            type: "radar",
            data: {
                labels: ["T", "L", "P", "Lo"],
                datasets: [{
                    data,
                    backgroundColor: "rgba(16,185,129,0.2)",
                    borderColor: "#10b981"
                }]
            },
            options: { plugins: { legend: { display: false } } }
        });
    }

    function generateCertificatePDF(data) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: "landscape" });

        // Design
        doc.setLineWidth(3);
        doc.setDrawColor(79, 70, 229); // Indigo border
        doc.rect(10, 10, 277, 190);

        doc.setFont("helvetica", "bold");
        doc.setFontSize(32);
        doc.setTextColor(15, 23, 42);
        doc.text("CERTIFICATE OF COMPLETION", 148.5, 40, { align: "center" });

        doc.setFontSize(16);
        doc.setFont("helvetica", "normal");
        doc.text("This certifies that", 148.5, 60, { align: "center" });

        doc.setFontSize(28);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(79, 70, 229);
        doc.text(data.studentName, 148.5, 80, { align: "center" });

        doc.setFontSize(16);
        doc.setTextColor(15, 23, 42);
        doc.setFont("helvetica", "normal");
        doc.text("Has successfully mastered the curriculum for", 148.5, 100, { align: "center" });

        doc.setFontSize(22);
        doc.setFont("helvetica", "bold");
        doc.text(data.courseName, 148.5, 115, { align: "center" });

        doc.setFontSize(12);
        doc.setFont("courier", "normal");
        doc.setTextColor(100);
        doc.text(`ID: ${data.certId} | Issued: ${new Date().toLocaleDateString()}`, 148.5, 135, { align: "center" });

        // Embed QR
        const canvas = document.querySelector("#issueQR canvas");
        if (canvas) {
            const imgData = canvas.toDataURL("image/png");
            doc.addImage(imgData, "PNG", 123.5, 145, 50, 50);
        }

        doc.save(`${data.studentName}_Certificate.pdf`);
    }
    </script>

    </body>
    </html>